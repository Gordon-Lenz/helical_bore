%
O9101 (HELICAL BORE CYCLE - PRE-NGC HAAS COMPATIBLE)
(REVISION DATE: 2023-10-27)
(WRITTEN BY: BARD (GOOGLE AI))

(DESCRIPTION: THIS SUBPROGRAM PERFORMS A HELICAL BORE CYCLE)
(WITH OPTIONAL RADIAL DEPTH REDUCTION AND A FINAL SPRING PASS.)
(IT IS DESIGNED TO BE COMPATIBLE WITH PRE-NGC HAAS CONTROLLERS.)

(PARAMETERS:)
(X - X CENTER - OPTIONAL, DEFAULT = CURRENT X)
(Y - Y CENTER - OPTIONAL, DEFAULT = CURRENT Y)
(R - R LEVEL - OPTIONAL, DEFAULT = 0.1)
(Z - FINAL BORE DEPTH - REQUIRED)
(D - BORE DIAMETER - REQUIRED)
(P - PITCH - OPTIONAL, DEFAULT = 10% OF TOOL DIAMETER)
(F - FEED RATE - REQUIRED)
(W - RADIAL DEPTH PER PASS - OPTIONAL, DEFAULT = 10% OF TOOL DIAMETER)
(T - TOOL NUMBER - OPTIONAL, DEFAULT = CURRENT TOOL)
(A - DEPTH REDUCTION FLAG (0 = OFF, 1 = ON) - OPTIONAL, DEFAULT = 0)
(N - POLYNOMIAL EXPONENT (DEFAULT = 2) - OPTIONAL)
(M - MESSAGE BYPASS FLAG (0 = OFF, 1 = ON) - OPTIONAL, DEFAULT = 0)

(CHECK FOR REQUIRED PARAMETERS)
IF[#4 EQ #0] GOTO9000 (ERROR: DIAMETER MISSING)
IF[#9 EQ #0] GOTO9002 (ERROR: FEED RATE MISSING)
IF[#26 EQ #0] GOTO9004 (ERROR: BORE DEPTH MISSING)

(SET DEFAULTS IF NOT PROVIDED)
IF[#24 EQ #0] THEN #24 = #5001 (DEFAULT X CENTER - CURRENT X)
IF[#25 EQ #0] THEN #25 = #5002 (DEFAULT Y CENTER - CURRENT Y)
IF[#18 EQ #0] THEN #18 = 0.1 (DEFAULT R LEVEL)
IF[#1 EQ #0] THEN #1 = 0 (DEFAULT DEPTH REDUCTION FLAG)
IF[#14 EQ #0] THEN #14 = 2 (DEFAULT POLYNOMIAL EXPONENT)
IF[#13 EQ #0] THEN #13 = 0 (DEFAULT MESSAGE BYPASS FLAG)

(HANDLE TOOL NUMBER - CHECK IF TOOL CHANGE IS NEEDED)
IF[#20 EQ #0] THEN (IF NO TOOL NUMBER IS PASSED)
  #36 = #5020 (GET CURRENT TOOL NUMBER)
ELSE (IF A TOOL NUMBER IS PASSED)
  IF[#20 NE #5020] THEN (IF REQUESTED TOOL IS DIFFERENT FROM CURRENT TOOL)
    M6 T#20 (PERFORM TOOL CHANGE)
  ENDIF
  #36 = #20 (USE THE REQUESTED TOOL NUMBER)
ENDIF

(CALCULATE TOOL RADIUS)
#35 = #[2000 + #36] / 2 (TOOL RADIUS)

(SET DEFAULTS FOR PITCH AND RADIAL DEPTH IF NOT PROVIDED)
IF[#16 EQ #0] THEN #16 = #35 * 0.2 (DEFAULT PITCH - 10% OF TOOL DIAMETER)
IF[#23 EQ #0] THEN #23 = #35 * 0.2 (DEFAULT RADIAL DOC - 10% OF TOOL DIAMETER)

(ERROR CHECK FOR INVALID INPUTS)
IF[#14 LT 0] GOTO9006 (ERROR: N MUST BE POSITIVE)
IF[#14 GT 4] GOTO9006 (ERROR: N MUST BE 1-4)
IF[#23 LE #0] GOTO9007 (ERROR: W MUST BE POSITIVE)
IF[#16 LE #0] GOTO9008 (ERROR: PITCH MUST BE POSITIVE)

(CALCULATIONS)
#19 = #5003 (CURRENT Z FOR CALCULATIONS)
#30 = ABS[#26 - #19] (TOTAL Z DEPTH TO BORE)
#34 = #4 / 2 (BORE RADIUS)
#37 = CEIL[[#34 - #35 - #35] / #23] (NUMBER OF RADIAL PASSES NEEDED)
#38 = 0 (CURRENT RADIAL PASS COUNTER)
#50 = 0 (TOTAL NUMBER OF PASSES COUNTER)

(CALCULATE ESTIMATED RUN TIME)
#51 = 3.14159 * #4 (BORE CIRCUMFERENCE)
#52 = #51 / #9 (TIME PER PASS AT FEED RATE)
#53 = #52 * #37 * [#30 / #16] (TOTAL TIME FOR HELICAL PASSES)
#54 = #37 * 5 * 0.2 / 60 (TOTAL TIME FOR RETRACTS AND DWELL - 5 RETRACTS PER RADIAL PASS, 0.2 SEC DWELL)
#55 = #51 * 2 / #9 (APPROXIMATE TIME FOR SPRING PASS WITH LEAD-IN/OUT)
#56 = #53 + #54 + #55 (TOTAL ESTIMATED RUN TIME IN MINUTES)
#50 = #37 * [#30 / #16] + #37 * 5 + 1 (CALCULATE TOTAL PASSES - HELICAL + RETRACTS + SPRING)

(RAPID TO START POSITION)
G0 X#24 Y#25
G43 H#36 Z#18 (APPLY TOOL LENGTH OFFSET)

(DISPLAY OPERATOR MESSAGE - PAUSE FOR CONFIRMATION)
IF[#13 EQ 0] THEN (ONLY DISPLAY IF MESSAGE BYPASS IS OFF)
  #3006 = 1 (CONFIRM: TOOL #[#36], DIAMETER #[#4], DEPTH #[#26], W #[#23], F #[#9], PITCH #[#16], DEPTH REDUCTION #[#1], EST. TIME #[#56] MIN, TOTAL PASSES #[#50] - PRESS CYCLE START)
ENDIF

G41 D#36 G1 X[#24 + 0.005] Y#25 F#9 (APPLY TOOL DIAMETER OFFSET - LEFT WITH SMALL ENGAGEMENT MOVE)

(RADIAL PASS LOOP)
WHILE[#38 LT #37] DO1
  #38 = #38 + 1 (INCREMENT RADIAL PASS COUNTER)

  (DEPTH REDUCTION LOGIC)
  IF[#1 EQ 1] THEN (IF DEPTH REDUCTION FLAG IS ON)
    #41 = #19 - #26 (CURRENT DEPTH)
    IF [#14 EQ 1] THEN #42 = #23 * [1 - [#41 / #30]]
    IF [#14 EQ 2] THEN #42 = #23 * [1 - [#41 / #30] * [#41 / #30]]
    IF [#14 EQ 3] THEN #42 = #23 * [1 - [#41 / #30] * [#41 / #30] * [#41 / #30]]
    IF [#14 EQ 4] THEN #42 = #23 * [1 - [#41 / #30] * [#41 / #30] * [#41 / #30] * [#41 / #30]]
    (REDUCE RADIAL DOC BASED ON Z DEPTH, POLYNOMIAL)
    IF[#42 LT [#23 * 0.5]] THEN #42 = [#23 * 0.5] (MINIMUM RADIAL DOC - 50% OF ORIGINAL)
    #39 = #34 - #35 - [#38 - 1] * #42 (CALCULATE RADIUS FOR THIS RADIAL PASS USING REDUCED DOC)
    IF[#39 LT #35] THEN #39 = #35
  ELSE
    #39 = #34 - #35 - [#38 - 1] * #23 (CALCULATE RADIUS FOR THIS RADIAL PASS)
    IF[#39 LT #35] THEN #39 = #35 (ENSURE RADIUS IS NOT SMALLER THAN TOOL RADIUS)
  ENDIF

  #31 = CEIL[#30 / #16] (NUMBER OF Z PASSES NEEDED, ROUND UP)
  #32 = 0 (CURRENT Z PASS COUNTER)
  #33 = #19 (CURRENT Z DEPTH)

  (MOVE TO START POSITION FOR THIS RADIAL PASS)
  G1 X[#24 + #39] Y#25 F#9
  G1 Z#19 F#9
  #40 = #39 * 0.25 (LEAD-IN RADIUS - 25% OF CURRENT CUTTING RADIUS)
  G3 X[#24 + #39] Y#25 I[-#40] F[#9 * 0.5] (LEAD-IN ARC AT 50% FEED)

  (Z PASS/HELICAL BORE LOOP)
  WHILE[#32 LT #31] DO2
    #32 = #32 + 1 (INCREMENT Z PASS COUNTER)
    #33 = #19 - [#32 * #16] (CALCULATE NEW Z DEPTH)

    IF[#33 LT #26] THEN #33 = #26 (ENSURE NOT DEEPER THAN FINAL Z DEPTH)

    (HELICAL INTERPOLATION)
    G3 X[#24 + #39] Y#25 Z[#33] I[-#39] F#9

    (CHIP EVACUATION - FULL RETRACT EVERY 3RD PASS)
    IF[MOD[#32, 3] EQ 0] THEN
      G0 Z#18
      G4 P0.2 (DWELL FOR CHIPS TO CLEAR)
      G1 Z[#33] F[#9 * 2] (FEED BACK DOWN AT TWICE THE FEED RATE)
    ENDIF

    (RETURN TO R LEVEL)
    G0 Z#18

    (RETURN TO CENTER FEED MOVE)
    G1 X#24 Y#25 F#9
    
  END2
  
END1

(SPRING PASS)
(RAPID TO CENTER AT R LEVEL)
G0 X#24 Y#25
G0 Z#18

(FEED DOWN TO FINAL DEPTH)
G1 Z#26 F[#9 * 2] (FEED TO BOTTOM AT 2 TIMES THE FEED FOR THE HELICAL MOVES)

(LEAD IN TO SPRING PASS)
#40 = #34 * 0.25 (LEAD-IN/OUT RADIUS - ADJUST AS NEEDED 25% WORKS WELL)
G1 X[#24 + #40] Y#25 F#9 (MOVE TO LEAD-IN START POINT)
G3 X[#24 + #34] Y#25 I[-#40] F[#9 * 0.5] (ARC INTO BORE AT 50% FEED)

(FULL CIRCLE SPRING PASS)
G3 I[-#34] (FULL CIRCLE AT BORE RADIUS)

(LEAD OUT FROM SPRING PASS)
G3 X[#24 + #40] Y#25 I[-#40] (ARC OUT FROM BORE)
G1 X#24 Y#25 F#9 (MOVE BACK TO CENTER)

(CANCEL CUTTER COMPENSATION AND RETRACT)
G40 G1 X[#24 + 0.005] Y#25 F#9 (MOVE TO COMPENSATE FOR CANCELLATION)
G0 Z#18

M99 (RETURN FROM SUBPROGRAM)

(ERROR HANDLING)
N9000 #3000 = 1 (ERROR: DIAMETER MISSING - D PARAM)
N9002 #3000 = 1 (ERROR: FEED RATE MISSING - F PARAM)
N9004 #3000 = 1 (ERROR: FINAL Z DEPTH MISSING - Z PARAM)
N9006 #3000 = 1 (ERROR: N MUST BE 1-4)
N9007 #3000 = 1 (ERROR: W MUST BE POSITIVE)
N9008 #3000 = 1 (ERROR: PITCH MUST BE POSITIVE)
M30
%